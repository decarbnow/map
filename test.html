<html>
    <head>
    </head>
    <body>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script>

        const API_URL = 'https://decarbnow.space/api';

        let tweets = [];

        $.get(API_URL + "/poi?size=100", function(data) {

            data._embedded.poi.forEach(function(item) {
              if(item.expandedUrl){
                  let tweetId = item.tweetId

                  let sp_hash = item.expandedUrl.indexOf('/@') + 2;
                  let ep_hash = item.expandedUrl.indexOf('/',sp_hash);

                  //get zoomLevel
                  let sp_z = item.expandedUrl.indexOf('/z=') + 3;
                  let ep_z = item.expandedUrl.indexOf('/',sp_z);

                  //get layers
                  let sp_ls = item.expandedUrl.indexOf('/ls=') + 4;
                  let ep_ls = item.expandedUrl.length;

                  tweets.push({ 'tweetId': tweetId,
                                '@': item.expandedUrl.substring(sp_hash,ep_hash),
                                'z': item.expandedUrl.substring(sp_z,ep_z),
                                'parentTweetId': item.inReplyToTweetId,
                                'type': item.type,
                                'replyFromSameUser': item.replyFromSameUser,
                                'ls': item.expandedUrl.substring(sp_ls,ep_ls).split(",")})
              }
          })
        });

        //TREE FUNCTION
        const createDataTree = dataset => {
            let hashTable = Object.create(null)
            dataset.forEach( aData => hashTable[aData.tweetId] = { ...aData, childNodes : [] } )
            let dataTree = []
            dataset.forEach( aData => {
                if( aData.parentTweetId ) hashTable[aData.parentTweetId].childNodes.push(hashTable[aData.tweetId])
                else dataTree.push(hashTable[aData.tweetId])
            } )

            return dataTree
        }

        //FLATTEN
        let preOrderTraverse = function(node, fn){ // sends values of tree to fn in pre-order
            fn(node); //call at preorder
            if(node.childNodes.length > 0){
                node.childNodes.forEach(function(e){
                    preOrderTraverse(e,fn);
                });
            }
        }

        //TEST
        let finalArray = [];
        getTweetArray = function(data){
          data.forEach((item, i) => {
              let nameEntry = data[i].tweetId
              finalArray[nameEntry] =  [];
              preOrderTraverse(createDataTree(data)[i],
                  function(node){ // do what you like with each node
                      //console.log(node);
                      finalArray[nameEntry].push(node);
                  }
              );
          });
        }

        getTweetArray(tweets)

      </script>
    </body>
</html>
