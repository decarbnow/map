<html>
    <head>
    </head>
    <body>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script>

        const API_URL = 'https://decarbnow.space/api';

        let tweets = [];
        let stories = {};

        $.get(API_URL + "/poi?size=100", function(data) {
            data._embedded.poi.forEach(function(item) {
              if(item.expandedUrl){
                  let tweetId = item.tweetId
                  //tweets[tweetId] = {};

                  let sp_hash = item.expandedUrl.indexOf('/@') + 2;
                  let ep_hash = item.expandedUrl.indexOf('/',sp_hash);
                  //tweets[tweetId]["@"]  = item.expandedUrl.substring(sp_hash,ep_hash)

                  //get zoomLevel
                  let sp_z = item.expandedUrl.indexOf('/z=') + 3;
                  let ep_z = item.expandedUrl.indexOf('/',sp_z);
                  //tweets[tweetId]['z'] = item.expandedUrl.substring(sp_z,ep_z)

                  //get layers
                  let sp_ls = item.expandedUrl.indexOf('/ls=') + 4;
                  let ep_ls = item.expandedUrl.length;
                  //tweets[tweetId]['ls']  = item.expandedUrl.substring(sp_ls,ep_ls).split(",")

                  tweets.push({ 'tweetId': tweetId,
                                '@': item.expandedUrl.substring(sp_hash,ep_hash),
                                'z': item.expandedUrl.substring(sp_z,ep_z),
                                'parentTweetId': item.inReplyToTweetId,
                                'type': item.type,
                                'replyFromSameUser': item.replyFromSameUser,
                                'ls': item.expandedUrl.substring(sp_ls,ep_ls).split(",")})

                  if(!item.replyFromSameUser){
                      stories[tweetId] = [];
                      stories[tweetId].push(tweetId)
                  }

              }
          })
        })

        var arry = [
                    { "tweetId": "3", "Name": "c", "parentTweetId": "4", "attr": "ass" },
                    { "tweetId": "1", "Name": "a", "parentTweetId": null, "attr": "ass" },
                    { "tweetId": "2", "Name": "b", "parentTweetId": "1", "attr": "ass" },
                    { "tweetId": "4", "Name": "d", "parentTweetId": null, "attr": "ass" }];

        //FIRST
        function buildHierarchy(arry) {

            var roots = [], children = {};

            // find the top level nodes and hash the children based on parent
            for (var i = 0, len = arry.length; i < len; ++i) {
                var item = arry[i],
                    p = item.parentTweetId,
                    target = !p ? roots : (children[p] || (children[p] = []));

                target.push({ value: item });
            }

            // function to recursively build the tree
            var findChildren = function(parent) {
                if (children[parent.value.tweetId]) {
                    parent.children = children[parent.value.tweetId];
                    for (var i = 0, len = parent.children.length; i < len; ++i) {
                        findChildren(parent.children[i]);
                    }
                }
            };

            // enumerate through to handle the case where there are multiple roots
            for (var i = 0, len = roots.length; i < len; ++i) {
                findChildren(roots[i]);
            }

            return roots;
        }

        //SECOND
        const createDataTree = dataset => {
            let hashTable = Object.create(null)
            dataset.forEach( aData => hashTable[aData.tweetId] = { ...aData, childNodes : [] } )
            let dataTree = []
            dataset.forEach( aData => {
                if( aData.parentTweetId ) hashTable[aData.parentTweetId].childNodes.push(hashTable[aData.tweetId])
                else dataTree.push(hashTable[aData.tweetId])
            } )

            return dataTree
        }

        //TESTING
        console.log(buildHierarchy(arry))
        console.log(createDataTree(arry))
      </script>
    </body>
</html>
